<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改通知配置 - 股票消息推送系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .dual-select-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .select-box {
            flex: 1;
        }
        .select-box select {
            height: 200px;
        }
        .transfer-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .transfer-buttons button {
            width: 60px;
            height: 40px;
        }
        @media (max-width: 768px) {
            .dual-select-container {
                flex-direction: column;
            }
            .transfer-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">修改爬虫配置的通知设置</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" id="notificationForm">
                            <div class="mb-3">
                                <label class="form-label">爬虫配置信息:</label>
                                <div class="alert alert-info">
                                    <strong>平台:</strong> {{ spider_config.platform }}<br>
                                    <strong>用户ID:</strong> {{ spider_config.user_id }}<br>
                                    <strong>用户名:</strong> {{ spider_config.username or '未设置' }}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">选择通知配置:</label>
                                <div class="dual-select-container">
                                    <!-- 待选择的通知配置 -->
                                    <div class="select-box">
                                        <label for="available-configs" class="form-label">待选择配置</label>
                                        <select class="form-select" id="available-configs" multiple>
                                            {% for config in notification_configs %}
                                                {% if config.id not in spider_config.current_notification_ids %}
                                                <option value="{{ config.id }}">
                                                    {{ config.config.name }} ({{ config.method }})
                                                </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- 转移按钮 -->
                                    <div class="transfer-buttons">
                                        <button type="button" class="btn btn-primary" id="add-btn" title="添加选中项">
                                            &gt;
                                        </button>
                                        <button type="button" class="btn btn-primary" id="add-all-btn" title="添加全部">
                                            &gt;&gt;
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="remove-btn" title="移除选中项">
                                            &lt;
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="remove-all-btn" title="移除全部">
                                            &lt;&lt;
                                        </button>
                                    </div>
                                    
                                    <!-- 已选择的通知配置 -->
                                    <div class="select-box">
                                        <label for="selected-configs" class="form-label">已选择配置</label>
                                        <select class="form-select" id="selected-configs" multiple>
                                            {% for config in notification_configs %}
                                                {% if config.id in spider_config.current_notification_ids %}
                                                <option value="{{ config.id }}">
                                                    {{ config.config.name }} ({{ config.method }})
                                                </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-text mt-2">双击配置项或使用中间按钮在两个框之间移动配置</div>
                            </div>
                            
                            <!-- 隐藏的输入字段，用于提交选中的配置ID -->
                            <input type="hidden" id="notification_config_ids" name="notification_config_ids" value="">
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{{ url_for('spider.spider_config') }}" class="btn btn-secondary me-md-2">取消</a>
                                <button type="submit" class="btn btn-primary">保存修改</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const availableConfigs = document.getElementById('available-configs');
            const selectedConfigs = document.getElementById('selected-configs');
            const addBtn = document.getElementById('add-btn');
            const addAllBtn = document.getElementById('add-all-btn');
            const removeBtn = document.getElementById('remove-btn');
            const removeAllBtn = document.getElementById('remove-all-btn');
            const hiddenInput = document.getElementById('notification_config_ids');
            const form = document.getElementById('notificationForm');

            // 移动选中的选项
            function moveOptions(from, to) {
                const selectedOptions = Array.from(from.selectedOptions);
                selectedOptions.forEach(option => {
                    to.appendChild(option);
                });
                updateHiddenInput();
            }

            // 移动所有选项
            function moveAllOptions(from, to) {
                const allOptions = Array.from(from.options);
                allOptions.forEach(option => {
                    to.appendChild(option);
                });
                updateHiddenInput();
            }

            // 更新隐藏输入字段
            function updateHiddenInput() {
                const selectedIds = Array.from(selectedConfigs.options).map(option => option.value);
                hiddenInput.value = selectedIds.join(',');
            }

            // 按钮事件
            addBtn.addEventListener('click', () => moveOptions(availableConfigs, selectedConfigs));
            addAllBtn.addEventListener('click', () => moveAllOptions(availableConfigs, selectedConfigs));
            removeBtn.addEventListener('click', () => moveOptions(selectedConfigs, availableConfigs));
            removeAllBtn.addEventListener('click', () => moveAllOptions(selectedConfigs, availableConfigs));

            // 双击事件
            availableConfigs.addEventListener('dblclick', (e) => {
                if (e.target.tagName === 'OPTION') {
                    selectedConfigs.appendChild(e.target);
                    updateHiddenInput();
                }
            });

            selectedConfigs.addEventListener('dblclick', (e) => {
                if (e.target.tagName === 'OPTION') {
                    availableConfigs.appendChild(e.target);
                    updateHiddenInput();
                }
            });

            // 初始化隐藏输入字段
            updateHiddenInput();

            // 表单提交前确保隐藏字段是最新的
            form.addEventListener('submit', function(e) {
                updateHiddenInput();
            });
        });
    </script>
</body>
</html>